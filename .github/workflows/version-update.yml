name: Auto Update Version

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v0.2.0, v1.0.0, etc.

permissions:
  contents: write
  pull-requests: write

jobs:
  update-version:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Extract version from tag
      id: version
      run: |
        # Get version from tag (remove 'v' prefix if exists)
        VERSION="${GITHUB_REF#refs/tags/}"
        VERSION="${VERSION#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Update version in cmd/root.go
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        sed -i "s/Version: \".*\"/Version: \"$VERSION\"/" cmd/root.go

        # Verify the change
        echo "Updated version in cmd/root.go:"
        grep "Version:" cmd/root.go

    - name: Verify build
      run: |
        go build -v -o dot-claude-sync
        ./dot-claude-sync --version

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: bump version to ${{ steps.version.outputs.version }}"
        branch: "auto/version-${{ steps.version.outputs.version }}"
        delete-branch: true
        title: "chore: bump version to ${{ steps.version.outputs.version }}"
        body: |
          ## Version Update

          This PR automatically updates the CLI version to `${{ steps.version.outputs.version }}` based on the git tag `${{ github.ref }}`.

          ### Changes
          - Updated `cmd/root.go` version field to `${{ steps.version.outputs.version }}`

          ### Trigger Information
          - **Git Tag**: `${{ github.ref_name }}`
          - **Commit SHA**: `${{ github.sha }}`

          ### Workflow
          1. Tag was pushed: `git tag v${{ steps.version.outputs.version }} && git push origin v${{ steps.version.outputs.version }}`
          2. This PR was automatically created
          3. After merging, create a GitHub Release from the tag

          **Note**: This PR was automatically created by the version update workflow.
        labels: |
          automated
          version-update
        assignees: ${{ github.actor }}
